<meta charset="utf-8">
<style> /* set the CSS */

.bar { fill: steelblue; }

</style>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://chancejs.com/chance.min.js"></script>

<body>
  <h1> Experiment </h1>
  <svg id="vis"> </svg>
</body>

<script>
  //https://chancejs.com
  //https://bl.ocks.org/d3noob/bdf28027e0ce70bd132edc64f1dd7ea4
  //https://stackoverflow.com/questions/44817414/rotate-svg-in-place-using-d3-js
  //https://medium.com/codecakes/bts-d3-js-basic-pie-chart-d794f17b79bb
  //https://observablehq.com/@d3/donut-chart
  //https://www.d3-graph-gallery.com/graph/treemap_basic.html
</script>

<script>
  var chance = new Chance(new Date().getTime())
  var color = "DodgerBlue"
  var color2 = "Orange"
  var margin = {top: 20, right: 20, bottom: 30, left: 40}
  var width = 500 - margin.left - margin.right
  var height = 500 - margin.top - margin.bottom
  var radius = Math.min(width, height) / 2

  var x = d3.scaleBand()
    .range([0, width])
    .padding(0.1);
  var y = d3.scaleLinear()
    .range([height, 0]);

  const pie = d3.pie()
    .sort(null)
    .value(d => d.data);

  const pieSorted = d3.pie()
    .value(d => d.data);

  const pieArc = d3.arc()
    .innerRadius(0)
    .outerRadius(radius);

  const donutArc = d3.arc()
    .innerRadius(radius * 0.67)
    .outerRadius(radius - 1);

  function removeDots(){
    svg.selectAll('circle').remove()
  }

  function getColor(data){
    if(data.dot)
      return color2
    return color
  }

  function singleDataPoint(){
    var data = {
      data: chance.integer({min: 50, max: 900}),
      dot: false,
      location: 0,
      parent: -1
    }
    return data
  }

  function createDataPoints(){
    var dataPoints = new Array(chance.integer({min: 5, max: 10}))
    for(var i = 0; i < dataPoints.length; i++){
      dataPoints[i] = singleDataPoint()
      dataPoints[i].location = i
    }
    return dataPoints
  }

  function selectTwoPoints(dataPoints){
    var point1 = chance.integer({min: 0, max: dataPoints.length-1})
    var point2 = chance.integer({min: 0, max: dataPoints.length-1})
    while(point1 == point2)
      point2 = chance.integer({min: 0, max: dataPoints.length-1})
    dataPoints[point1].dot = true
    dataPoints[point2].dot = true
    return dataPoints
  }

  function verticalBarChart(dataPoints, renderDot=false, altColor=false){
    x.domain(dataPoints.map(function(d) { return d.location; }));
    y.domain([0, d3.max(dataPoints, function(d) { return d.data; })]);

    svg.selectAll("bar")
      .data(dataPoints).enter()
      .append("rect")
        .style("fill", d => getColor(d))
        .attr("x", d => x(d.location)-(width/2))
        .attr("y", d => y(d.data)-(height/2))
        .attr("height", d => height - y(d.data))
        .attr("width", x.bandwidth())
        .attr("stroke", "black")
        .style("stroke-width", "2px")
  }

  function horizontalBarChart(dataPoints, renderDot=false, altColor=false){
    verticalBarChart(dataPoints, renderDot, altColor)
    svg.attr('transform',function(){
                var me = svg.node()
                var x1 = me.getBBox().width/2 - (height/2) + margin.top/2;
                var y1 = me.getBBox().height/2 + margin.left/2;

                return `rotate(90, ${x1}, ${y1})`;
            });
  }

  function removeBarChart(){
    svg.selectAll('bar').remove()
    svg.selectAll('rect').remove()
    removeDots()
  }

  function pieChart(dataPoints, renderDot=false, altColor=false){
    svg.selectAll('path')
      .data(pie(dataPoints))
      .enter()
      .append('path')
      .attr('d', pieArc)
      .attr('fill', d => getColor(d.data))
      .attr("stroke", "black")
      .style("stroke-width", "2px")
  }

  function donutChart(dataPoints, renderDot=false, altColor=false){
    svg.selectAll('path')
      .data(pie(dataPoints))
      .enter()
      .append('path')
      .attr('d', donutArc)
      .attr('fill', d => getColor(d.data))
      .attr("stroke", "black")
      .style("stroke-width", "2px")
  }

  function removePieChart(){
    svg.selectAll('path').remove()
    removeDots()
  }

  function treemap(dataPoints, renderDot=false, altColor=false){

    dataPoints.unshift({index: -1})

    var root = d3.stratify()
      .id(function(d) { return d.index; })
      .parentId(function(d) { return d.parent; })
      (dataPoints);
    root.sum(function(d) { return +d.data })

    d3.treemap()
      .size([width, height])
      .padding(4)
      (root)

    svg.selectAll("rect")
    .data(root.leaves())
    .enter()
    .append("rect")
      .attr('x', function (d) { return d.x0-(width/2); })
      .attr('y', function (d) { return d.y0-(height/2); })
      .attr('width', function (d) { return d.x1 - d.x0; })
      .attr('height', function (d) { return d.y1 - d.y0; })
      .style("stroke", "black")
      .style("stroke-width", "2px")
      .style("fill", d => getColor(d.data))
  }

  function removeTreeMap(){
    svg.selectAll('rect').remove()
    removeDots()
  }

  var svg = d3.select('#vis')
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom + 10)
    .append("g")
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
  data = createDataPoints()
  selectTwoPoints(data)

  donutChart(data, false, true)

</script>
